<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Studio 3D Uploader</title>
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
<style>
    :root {
        --primary: #4f46e5;
        --primary-dark: #4338ca;
        --bg: #0f172a;
        --panel: #111827;
        --text: #e5e7eb;
        --muted: #9ca3af;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: radial-gradient(circle at 20% 20%, rgba(79, 70, 229, 0.15), transparent 30%),
                    radial-gradient(circle at 80% 10%, rgba(16, 185, 129, 0.14), transparent 28%),
                    var(--bg);
        min-height: 100vh;
        color: var(--text);
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 24px;
    }

    .container {
        width: 100%;
        max-width: 1100px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .card {
        background: var(--panel);
        border: 1px solid #1f2937;
        border-radius: 16px;
        box-shadow: 0 25px 45px rgba(0,0,0,0.35);
        padding: 24px;
    }

    h2 { margin-bottom: 8px; font-size: 22px; }
    p { color: var(--muted); margin-bottom: 18px; }

    .drop-zone {
        border: 2px dashed #374151;
        border-radius: 14px;
        padding: 36px 20px;
        background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(59, 130, 246, 0.05));
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 200px;
    }

    .drop-zone:hover { border-color: var(--primary); box-shadow: 0 10px 30px rgba(79, 70, 229, 0.25); }
    .drop-zone.highlight { border-color: #22d3ee; background: rgba(34, 211, 238, 0.07); }
    .icon { font-size: 54px; margin-bottom: 12px; }

    input[type="file"] {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        opacity: 0; cursor: pointer;
    }

    .btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(90deg, var(--primary), #6366f1);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 700;
        font-size: 15px;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        margin-top: 18px;
    }

    .btn:hover { transform: translateY(-1px); box-shadow: 0 12px 25px rgba(79, 70, 229, 0.35); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

    .file-list {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
        margin-top: 12px;
        max-height: 320px;
        overflow: auto;
        padding-right: 4px;
    }

    .file-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        padding: 12px;
        border-radius: 12px;
        background: #0b1221;
        border: 1px solid #1f2937;
        align-items: center;
    }

    .file-meta { font-size: 13px; color: var(--muted); }
    .file-name { font-weight: 700; color: #e5e7eb; }
    .tag { padding: 4px 8px; background: rgba(16,185,129,0.12); color: #34d399; border-radius: 8px; font-size: 12px; }

    .actions { display: flex; gap: 8px; }
    .chip-btn {
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid #1f2937;
        background: #111827;
        color: #e5e7eb;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
    }
    .chip-btn:hover { background: #1f2937; }

    model-viewer {
        width: 100%;
        height: 400px;
        border-radius: 14px;
        background: radial-gradient(circle at 30% 20%, rgba(99, 102, 241, 0.12), transparent 45%),
                    radial-gradient(circle at 70% 80%, rgba(16, 185, 129, 0.12), transparent 40%),
                    #0b1221;
        border: 1px solid #1f2937;
    }

    .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    @media (max-width: 960px) {
        .container { grid-template-columns: 1fr; }
    }
</style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>üöÄ Upload 3D Model</h2>
        <p>K√©o th·∫£ ho·∫∑c ch·ªçn nhi·ªÅu file GLB/GLTF ƒë·ªÉ t·∫£i l√™n m√°y ch·ªß.</p>

        <form id="uploadForm">
            <div class="drop-zone" id="dropZone">
                <span class="icon">‚òÅÔ∏è</span>
                <strong id="instruction-text">Click ho·∫∑c K√©o th·∫£ file v√†o ƒë√¢y</strong>
                <div id="file-name-display"></div> <div class="file-hint">C√≥ th·ªÉ ch·ªçn nhi·ªÅu file .GLB, .GLTF</div>

                <input type="file" name="files" id="fileInput" accept=".glb, .gltf" multiple required>
            </div>

            <button type="submit" class="btn" id="submitBtn">T·∫£i l√™n ngay</button>
        </form>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('file-name-display');
        const instructionText = document.getElementById('instruction-text');
        const uploadForm = document.getElementById('uploadForm');
        const submitBtn = document.getElementById('submitBtn');

        // 1. Hi·ªáu ·ª©ng hi·ªÉn th·ªã t√™n file khi ng∆∞·ªùi d√πng ch·ªçn
        fileInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                const names = Array.from(this.files).map(f => f.name).join(', ');
                fileNameDisplay.textContent = names;
                instructionText.style.display = 'none';
            }
        });

        <model-viewer id="viewer" camera-controls auto-rotate ar ar-modes="webxr scene-viewer quick-look" shadow-intensity="1" exposure="0.9">
        </model-viewer>

            // L·∫•y file
            const files = fileInput.files;
            if (!files || files.length === 0) {
                alert("Vui l√≤ng ch·ªçn file tr∆∞·ªõc!");
                return;
            }

            // T·∫°o d·ªØ li·ªáu form ƒë·ªÉ g·ª≠i
            const formData = new FormData();
            Array.from(files).forEach(file => formData.append('files', file));

        models.forEach((model) => {
            const row = document.createElement('div');
            row.className = 'file-row';

            const left = document.createElement('div');
            const name = document.createElement('div');
            name.className = 'file-name';
            name.textContent = model.name;

            const meta = document.createElement('div');
            meta.className = 'file-meta';
            meta.textContent = `${formatSize(model.size)} ¬∑ ${new Date(model.uploadedAt).toLocaleString()}`;

            left.appendChild(name);
            left.appendChild(meta);

            const actions = document.createElement('div');
            actions.className = 'actions';

            const previewBtn = document.createElement('button');
            previewBtn.className = 'chip-btn';
            previewBtn.textContent = 'Xem';
            previewBtn.onclick = () => selectModel(model);

            const copyBtn = document.createElement('button');
            copyBtn.className = 'chip-btn';
            copyBtn.textContent = 'Copy link';
            copyBtn.onclick = () => copyLink(model.url);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'chip-btn';
            deleteBtn.textContent = 'Xo√°';
            deleteBtn.onclick = () => deleteModel(model.name);

            actions.appendChild(previewBtn);
            actions.appendChild(copyBtn);
            actions.appendChild(deleteBtn);

            row.appendChild(left);
            row.appendChild(actions);

            fileList.appendChild(row);
        });
    }

    function selectModel(model) {
        currentModel = model;
        viewer.src = model.url;
        copyLink(model.url, false);
    }

    function copyLink(link, silent = false) {
        navigator.clipboard.writeText(link).then(() => {
            if (!silent) alert('ƒê√£ copy link: ' + link);
        });
    }

    function deleteModel(name) {
        if (!confirm('B·∫°n ch·∫Øc ch·∫Øn xo√° model n√†y?')) return;
        fetch(`/api/models/${encodeURIComponent(name)}`, { method: 'DELETE' })
            .then(res => {
                if (!res.ok) throw new Error('Kh√¥ng th·ªÉ xo√°');
                return res.json();
            })
            .then(() => fetchModels())
            .catch(() => alert('Kh√¥ng xo√° ƒë∆∞·ª£c file'));
    }

    function fetchModels() {
        fetch('/api/models')
            .then(res => res.json())
            .then(data => {
                models = data.models || [];
                renderList();
                if (models.length && !currentModel) {
                    selectModel(models[0]);
                }
            })
            .catch(() => fileList.innerHTML = '<div class="file-meta">Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch</div>');
    }

    // 1. Hi·ªáu ·ª©ng hi·ªÉn th·ªã t√™n file khi ng∆∞·ªùi d√πng ch·ªçn
    fileInput.addEventListener('change', function() {
        if (this.files && this.files.length > 0) {
            const names = Array.from(this.files).map(f => f.name).join(', ');
            fileNameDisplay.textContent = names;
            instructionText.style.display = 'none';
        }
    });

    // Drag & drop
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, e => {
            e.preventDefault();
            dropZone.classList.add('highlight');
        });
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, e => {
            e.preventDefault();
            dropZone.classList.remove('highlight');
        });
    });

    dropZone.addEventListener('drop', e => {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files;
        const names = Array.from(files).map(f => f.name).join(', ');
        fileNameDisplay.textContent = names;
        instructionText.style.display = 'none';
    });

    // 2. X·ª≠ l√Ω khi b·∫•m n√∫t "T·∫£i l√™n"
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const files = fileInput.files;
        if (!files || files.length === 0) {
            alert("Vui l√≤ng ch·ªçn file tr∆∞·ªõc!");
            return;
        }

        const formData = new FormData();
        Array.from(files).forEach(file => formData.append('files', file));

        submitBtn.textContent = "ƒêang t·∫£i l√™n...";
        submitBtn.disabled = true;

        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                alert("‚úÖ Upload th√†nh c√¥ng!");
                fetchModels();
                fileInput.value = '';
                fileNameDisplay.textContent = 'Ch∆∞a ch·ªçn file';
                instructionText.style.display = 'block';
            } else {
                alert("‚ùå L·ªói Server!");
            }
        })
        .catch(error => {
            console.error('L·ªói:', error);
            alert("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi Server.");
        })
        .finally(() => {
            submitBtn.textContent = "T·∫£i l√™n ngay";
            submitBtn.disabled = false;
        });
    });

    btnRefresh.addEventListener('click', fetchModels);
    btnCopy.addEventListener('click', () => {
        if (!currentModel) return alert('Ch∆∞a ch·ªçn model');
        copyLink(currentModel.url);
    });

    fetchModels();
</script>

</body>
</html>
